<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tiny Support</title>
  <style>
    /* ============================================================
       VibeLive Teal Design Tokens
       ============================================================ */
    :root {
      --radius: 16px;
      --max: 980px;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

      /* surfaces */
      --bg: #f7f9f8;
      --card: #ffffff;
      --soft: #f0f4f3;
      --border: #e2e8f0;
      --borderSoft: #dbe2ea;

      /* text */
      --text: #1e293b;
      --muted: #64748b;
      --muted2: #9ca3af;

      /* brand */
      --accent: #0EA5A4;
      --accentHover: #0d9488;
      --accentSoft: rgba(14,165,164,.10);
      --accentBorder: rgba(14,165,164,.35);

      /* status */
      --liveBg: #e8f4ed;
      --liveBorder: #a6c5a3;
      --liveText: #324252;

      --disabledBg: #f3f4f6;
      --disabledBorder: #e5e7eb;
      --disabledText: #6b7280;

      /* danger */
      --dangerBg: #FEF2F2;
      --dangerBorder: #fca5a5;
      --dangerText: #b91c1c;

      /* overlay */
      --overlay: rgba(30, 41, 59, 0.5);
    }

    /* ============================================================
       Reset & Base
       ============================================================ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--sans);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* ============================================================
       Utility
       ============================================================ */
    .hidden { display: none !important; }

    /* ============================================================
       Entry Screen
       ============================================================ */
    #entryView {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 24px;
    }

    .entry-container {
      width: 100%;
      max-width: 420px;
    }

    .entry-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .entry-header h1 {
      font-size: 24px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
    }

    .entry-header p {
      font-size: 14px;
      color: var(--muted);
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 16px;
    }

    .card-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }

    .input-group {
      margin-bottom: 12px;
    }

    .input-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--muted);
      margin-bottom: 4px;
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 10px 14px;
      font-size: 15px;
      font-family: var(--sans);
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--card);
      color: var(--text);
      outline: none;
      transition: border-color 0.15s;
    }

    input:focus {
      border-color: var(--accentBorder);
      box-shadow: 0 0 0 3px var(--accentSoft);
    }

    input::placeholder {
      color: var(--muted2);
    }

    /* ============================================================
       Buttons
       ============================================================ */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 20px;
      font-size: 15px;
      font-weight: 600;
      font-family: var(--sans);
      border-radius: 10px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 0.15s;
      line-height: 1.4;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .btn-primary:hover:not(:disabled) {
      background: var(--accentHover);
      border-color: var(--accentHover);
    }

    .btn-secondary {
      background: var(--soft);
      color: var(--text);
      border-color: var(--border);
    }
    .btn-secondary:hover:not(:disabled) {
      border-color: var(--borderSoft);
      background: #e8edec;
    }

    .btn-danger {
      background: var(--dangerBg);
      color: var(--dangerText);
      border-color: var(--dangerBorder);
    }
    .btn-danger:hover:not(:disabled) {
      background: #fde8e8;
    }

    .btn-full { width: 100%; }

    .btn-icon {
      width: 44px;
      height: 44px;
      padding: 0;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-icon svg { width: 20px; height: 20px; }

    /* ============================================================
       Divider
       ============================================================ */
    .divider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 16px 0;
      color: var(--muted2);
      font-size: 13px;
    }
    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* ============================================================
       Join row
       ============================================================ */
    .join-row {
      display: flex;
      gap: 8px;
    }

    .join-row input {
      flex: 1;
      font-family: monospace;
      font-size: 16px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .join-row .btn {
      flex-shrink: 0;
    }

    /* ============================================================
       Mode toggle
       ============================================================ */
    .mode-toggle {
      text-align: center;
      margin-top: 8px;
    }

    .mode-toggle button {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 14px;
      font-family: var(--sans);
      cursor: pointer;
      padding: 4px 8px;
    }
    .mode-toggle button:hover {
      text-decoration: underline;
    }

    /* ============================================================
       Status message
       ============================================================ */
    .status-msg {
      font-size: 13px;
      margin-top: 12px;
      min-height: 20px;
    }
    .status-msg.error { color: var(--dangerText); }
    .status-msg.success { color: var(--liveText); }

    /* ============================================================
       Agent password gate
       ============================================================ */
    #agentGate .card-label {
      color: var(--accent);
    }

    /* ============================================================
       Room View (In-Call)
       ============================================================ */
    #roomView {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #0f1419;
      color: #fff;
    }

    /* Room header */
    .room-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: rgba(15, 20, 25, 0.95);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      z-index: 10;
    }

    .room-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .room-title {
      font-size: 15px;
      font-weight: 600;
    }

    .room-code-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
      font-family: monospace;
      font-size: 14px;
      letter-spacing: 1px;
    }

    .room-code-badge button {
      background: none;
      border: none;
      color: rgba(255,255,255,0.6);
      cursor: pointer;
      padding: 2px;
      display: flex;
      align-items: center;
    }
    .room-code-badge button:hover { color: #fff; }
    .room-code-badge button svg { width: 16px; height: 16px; }

    .room-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .participant-count {
      font-size: 13px;
      color: rgba(255,255,255,0.6);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .participant-count svg { width: 16px; height: 16px; }

    .live-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      background: var(--liveBg);
      border: 1px solid var(--liveBorder);
      color: var(--liveText);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .live-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      background: #22c55e;
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* ============================================================
       Video Stage Area
       ============================================================ */
    .stage-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 12px;
      gap: 12px;
    }

    /* Main stage: screen share or spotlight */
    .main-stage {
      flex: 1;
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: #1a2029;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .main-stage video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .main-stage .stage-label {
      position: absolute;
      bottom: 12px;
      left: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 12px;
      background: rgba(0,0,0,0.6);
      border-radius: 8px;
      font-size: 13px;
    }

    .main-stage .stage-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      color: rgba(255,255,255,0.4);
    }

    .main-stage .stage-placeholder svg { width: 48px; height: 48px; }

    /* Screen share banner */
    .screen-share-banner {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--accent);
      color: #fff;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      z-index: 5;
    }

    .screen-share-banner button {
      background: rgba(255,255,255,0.2);
      border: none;
      color: #fff;
      padding: 4px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-family: var(--sans);
    }
    .screen-share-banner button:hover { background: rgba(255,255,255,0.3); }

    /* Participant strip (bottom row of camera tiles) */
    .participant-strip {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      flex-shrink: 0;
      padding: 4px 0;
    }

    .participant-strip::-webkit-scrollbar { height: 4px; }
    .participant-strip::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

    /* ============================================================
       Video Tile
       ============================================================ */
    .video-tile {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: #1a2029;
      flex-shrink: 0;
    }

    .video-tile video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .video-tile .tile-label {
      position: absolute;
      bottom: 8px;
      left: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      background: rgba(0,0,0,0.6);
      border-radius: 6px;
      font-size: 12px;
      color: #fff;
    }

    .tile-label .role-tag {
      font-size: 10px;
      font-weight: 600;
      padding: 1px 6px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .role-tag.agent { background: var(--accent); color: #fff; }
    .role-tag.customer { background: rgba(255,255,255,0.18); color: rgba(255,255,255,0.85); }

    .video-tile .tile-mute-icon {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      border-radius: 50%;
    }
    .video-tile .tile-mute-icon svg { width: 14px; height: 14px; color: #ef4444; }

    .video-tile .tile-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      color: rgba(255,255,255,0.7);
    }

    .tile-initials {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accentSoft);
      border: 2px solid var(--accentBorder);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 6px;
    }

    .tile-name {
      font-size: 13px;
      font-weight: 500;
    }

    .tile-role {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 4px;
      margin-top: 4px;
    }

    .tile-role.agent {
      background: var(--accentSoft);
      color: var(--accent);
    }

    .tile-role.customer {
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.6);
    }

    /* Strip tile sizing */
    .participant-strip .video-tile {
      width: 200px;
      height: 140px;
    }

    /* Full-stage tile (when no screen share, 1-2 participants) */
    .video-tile.full-stage {
      flex: 1;
    }

    /* ============================================================
       Controls Bar
       ============================================================ */
    .controls-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 16px 20px;
      background: rgba(15, 20, 25, 0.95);
      border-top: 1px solid rgba(255,255,255,0.08);
    }

    .control-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      position: relative;
    }

    .control-btn svg { width: 22px; height: 22px; }

    .control-btn.active {
      background: rgba(255,255,255,0.12);
      color: #fff;
    }
    .control-btn.active:hover {
      background: rgba(255,255,255,0.18);
    }

    .control-btn.inactive {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }
    .control-btn.inactive:hover {
      background: rgba(239, 68, 68, 0.25);
    }

    .control-btn.screen-active {
      background: var(--accent);
      color: #fff;
    }
    .control-btn.screen-active:hover {
      background: var(--accentHover);
    }

    .control-btn.leave {
      background: #ef4444;
      color: #fff;
      width: 56px;
      height: 48px;
      border-radius: 24px;
      margin-left: 20px;
    }
    .control-btn.leave:hover {
      background: #dc2626;
    }

    .control-btn .control-label {
      display: none;
    }

    /* ============================================================
       Waiting state
       ============================================================ */
    .waiting-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(15, 20, 25, 0.9);
      z-index: 20;
    }

    .waiting-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .waiting-text {
      font-size: 16px;
      color: rgba(255,255,255,0.7);
    }

    .waiting-subtext {
      font-size: 13px;
      color: rgba(255,255,255,0.4);
      margin-top: 4px;
    }

    /* ============================================================
       Copy feedback
       ============================================================ */
    .copy-ok {
      color: #22c55e !important;
    }

    /* ============================================================
       Responsive
       ============================================================ */
    @media (max-width: 640px) {
      .participant-strip .video-tile {
        width: 140px;
        height: 100px;
      }
      .participant-strip .tile-initials {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }
      .room-header {
        padding: 10px 14px;
      }
      .controls-bar {
        padding: 12px 14px;
        gap: 10px;
      }
      .control-btn {
        width: 44px;
        height: 44px;
      }
    }
  </style>
</head>
<body>

  <!-- ============================================================
       VIEW 1: Entry Screen
       ============================================================ -->
  <div id="entryView">
    <div class="entry-container">
      <div class="entry-header">
        <h1>Tiny Support</h1>
        <p>Video support optimized for screen sharing</p>
      </div>

      <!-- Customer mode (default) -->
      <div id="customerEntry">
        <!-- Name card -->
        <div class="card">
          <div class="card-label">Your Info</div>
          <div class="input-group">
            <label for="customerName">Display name</label>
            <input type="text" id="customerName" placeholder="Your name">
          </div>
          <div class="input-group">
            <label for="customerPid">Account ID (optional)</label>
            <input type="text" id="customerPid" placeholder="e.g. CUST-1234">
          </div>
        </div>

        <!-- Action card -->
        <div class="card">
          <div class="card-label">Get Support</div>
          <button class="btn btn-primary btn-full" id="btnStartRoom" onclick="startRoom()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M3 6h9a2 2 0 012 2v8a2 2 0 01-2 2H3a1 1 0 01-1-1V7a1 1 0 011-1z"/></svg>
            Start Support Room
          </button>

          <div class="divider">or</div>

          <div class="input-group">
            <label>Join with room code</label>
          </div>
          <div class="join-row">
            <input type="text" id="customerRoomCode" placeholder="ABC123" maxlength="10" oninput="updateJoinPriority()">
            <button class="btn btn-secondary" id="btnJoinRoom" onclick="joinRoomCustomer()">Join</button>
          </div>
          <div class="status-msg" id="customerStatus"></div>
        </div>

        <div class="mode-toggle">
          <button onclick="showAgentEntry()">Agent login</button>
        </div>
      </div>

      <!-- Agent mode -->
      <div id="agentEntry" class="hidden">
        <div class="card" id="agentGate">
          <div class="card-label">Agent Access</div>
          <div class="input-group">
            <label for="agentPassword">Agent password</label>
            <input type="password" id="agentPassword" placeholder="Enter agent password">
          </div>
          <div class="input-group">
            <label for="agentName">Your name</label>
            <input type="text" id="agentName" placeholder="Agent name">
          </div>
        </div>

        <div class="card">
          <div class="card-label">Join Session</div>
          <div class="input-group">
            <label>Room code from customer</label>
          </div>
          <div class="join-row">
            <input type="text" id="agentRoomCode" placeholder="ABC123" maxlength="10">
            <button class="btn btn-primary" onclick="joinRoomAgent()">Join as Agent</button>
          </div>
          <div class="status-msg" id="agentStatus"></div>
        </div>

        <div class="mode-toggle">
          <button onclick="showCustomerEntry()">Back to customer view</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================================
       VIEW 2: Room (In-Call)
       ============================================================ -->
  <div id="roomView" class="hidden">
    <!-- Header -->
    <div class="room-header">
      <div class="room-header-left">
        <span class="room-title" id="roomTitle">Support Room</span>
        <div class="room-code-badge">
          <span id="roomCodeDisplay">---</span>
          <button onclick="copyRoomCode()" title="Copy room code" id="copyCodeBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
          </button>
          <button onclick="copyShareLink()" title="Copy share link" id="copyLinkBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
          </button>
        </div>
      </div>
      <div class="room-header-right">
        <div class="participant-count" id="participantCount">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
          <span id="memberCountText">0</span>
        </div>
        <span class="live-badge" id="liveBadge">LIVE</span>
      </div>
    </div>

    <!-- Stage area -->
    <div class="stage-area">
      <!-- Main stage (screen share or spotlight video) -->
      <div class="main-stage" id="mainStage">
        <div class="stage-placeholder" id="stagePlaceholder">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          <span style="font-size:14px;">Share your screen for support</span>
        </div>
        <video id="mainStageVideo" autoplay playsinline style="display:none;"></video>
        <div class="stage-label hidden" id="mainStageLabel">
          <span id="mainStageName"></span>
        </div>
        <!-- Screen share banner (only for local screen share) -->
        <div class="screen-share-banner hidden" id="screenShareBanner">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          You are sharing your screen
          <button onclick="stopScreenShare()">Stop</button>
        </div>
      </div>

      <!-- Participant strip -->
      <div class="participant-strip" id="participantStrip">
        <!-- Local tile -->
        <div class="video-tile" id="tile-local" style="width:200px;height:140px;">
          <video id="localVideo" autoplay muted playsinline></video>
          <div class="tile-placeholder" id="localPlaceholder">
            <div class="tile-initials" id="localInitials">?</div>
            <div class="tile-name" id="localName">You</div>
          </div>
          <div class="tile-label">
            <span id="localLabelName">You</span>
            <span class="role-tag" id="localRoleTag"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls-bar">
      <button class="control-btn active" id="btnAudio" onclick="toggleAudio()" title="Toggle microphone">
        <svg id="iconMic" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 00-3 3v7a3 3 0 006 0V5a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/></svg>
        <svg id="iconMicOff" class="hidden" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="1" y1="1" x2="23" y2="23"/><path d="M9 9v3a3 3 0 005.12 2.12M15 9.34V5a3 3 0 00-5.94-.6"/><path d="M17 16.95A7 7 0 015 12v-2m14 0v2c0 .76-.12 1.5-.35 2.18"/><line x1="12" y1="19" x2="12" y2="22"/></svg>
      </button>

      <button class="control-btn active" id="btnVideo" onclick="toggleVideo()" title="Toggle camera">
        <svg id="iconCam" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M3 6h9a2 2 0 012 2v8a2 2 0 01-2 2H3a1 1 0 01-1-1V7a1 1 0 011-1z"/></svg>
        <svg id="iconCamOff" class="hidden" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="1" y1="1" x2="23" y2="23"/><path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14"/><rect x="2" y="6" width="12" height="12" rx="2"/></svg>
      </button>

      <button class="control-btn active" id="btnScreen" onclick="toggleScreen()" title="Share screen">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
      </button>

      <button class="control-btn leave" id="btnLeave" onclick="leaveCall()" title="Leave call">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.68 13.31a16 16 0 003.41 2.6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7 2 2 0 011.72 2v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.42 19.42 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l-3.41-2.6z" transform="rotate(135 12 12)"/></svg>
      </button>
    </div>
  </div>

  <!-- ============================================================
       MiniChatCore Integration
       ============================================================ -->
  <script type="importmap">
  {
    "imports": {
      "minichat-core": "https://proto2.makedo.com:8883/v02/scripts/minichat-core.js",
      "config": "https://proto2.makedo.com:8883/v02/scripts/configServer.js"
    }
  }
  </script>

  <script type="module">
    import MiniChatCore from 'minichat-core';

    // ============================================================
    // Config
    // ============================================================
    const CONTEXT_CONFIG = {
      contextId: 'Kw6w6w6w6w',
      contextAuthToken: 'Kw6w6w6w6w'
    };

    const AGENT_PASSWORD = 'support2024';
    const MAX_PARTICIPANTS = 4;

    // ============================================================
    // State
    // ============================================================
    let chat = null;
    let currentRole = 'customer'; // 'customer' | 'agent' | 'guest'
    let myName = '';
    let myPid = '';
    let isScreenSharing = false;
    let audioOn = false;
    let videoOn = false;
    const remoteTiles = new Map(); // memberId -> { camera: element, screencast: element }
    let mainStageMemberId = null;
    let mainStageStreamType = null;

    // Make functions available globally for onclick handlers
    window.startRoom = startRoom;
    window.joinRoomCustomer = joinRoomCustomer;
    window.joinRoomAgent = joinRoomAgent;
    window.showAgentEntry = showAgentEntry;
    window.showCustomerEntry = showCustomerEntry;
    window.copyRoomCode = copyRoomCode;
    window.copyShareLink = copyShareLink;
    window.toggleAudio = toggleAudio;
    window.toggleVideo = toggleVideo;
    window.toggleScreen = toggleScreen;
    window.stopScreenShare = stopScreenShare;
    window.leaveCall = leaveCall;
    window.updateJoinPriority = updateJoinPriority;

    // ============================================================
    // Check URL for room code
    // ============================================================
    const urlParams = new URLSearchParams(window.location.search);
    const urlCode = urlParams.get('code');
    if (urlCode) {
      document.getElementById('customerRoomCode').value = urlCode;
      updateJoinPriority();
    }

    // ============================================================
    // Entry Mode Switching
    // ============================================================
    function showAgentEntry() {
      document.getElementById('customerEntry').classList.add('hidden');
      document.getElementById('agentEntry').classList.remove('hidden');
    }

    function showCustomerEntry() {
      document.getElementById('agentEntry').classList.add('hidden');
      document.getElementById('customerEntry').classList.remove('hidden');
    }

    // Dynamic button priority (VibeLive pattern)
    function updateJoinPriority() {
      const code = document.getElementById('customerRoomCode').value.trim();
      const startBtn = document.getElementById('btnStartRoom');
      const joinBtn = document.getElementById('btnJoinRoom');

      if (code.length > 0) {
        startBtn.className = 'btn btn-secondary btn-full';
        joinBtn.className = 'btn btn-primary';
      } else {
        startBtn.className = 'btn btn-primary btn-full';
        joinBtn.className = 'btn btn-secondary';
      }
    }

    // ============================================================
    // Initialize MiniChatCore
    // ============================================================
    function initChat() {
      chat = new MiniChatCore(CONTEXT_CONFIG);
      window.chat = chat; // For debugging

      // Set local video element
      chat.setLocalVideoElement(document.getElementById('localVideo'));

      // ---- Events ----

      chat.onJoined = () => {
        console.log('[tiny-support] Joined - LIVE');
        document.getElementById('liveBadge').classList.remove('hidden');
        updateMemberCount();
      };

      chat.onLeft = () => {
        console.log('[tiny-support] Left - returned to lobby');
      };

      chat.onMemberJoined = (memberId) => {
        const member = chat.getMember(memberId);
        console.log(`[tiny-support] Member joined: ${member?.username || memberId}`);
        createRemoteCameraTile(memberId);
        updateMemberCount();
      };

      chat.onMemberLeft = (memberId) => {
        const member = chat.getMember(memberId);
        const status = chat.getDisplayStatus(member?.member_status);
        console.log(`[tiny-support] Member left: ${member?.username || memberId} (${status})`);

        if (status !== 'LOBBY') {
          removeRemoteTiles(memberId);
        }
        updateMemberCount();

        // If this member was on main stage, clear it
        if (mainStageMemberId === memberId) {
          clearMainStage();
        }
      };

      chat.onMemberUpdate = (memberId) => {
        // Update tile status if needed
        updateMemberCount();
      };

      chat.onMemberStreamStart = (memberId, streamType) => {
        const member = chat.getMember(memberId);
        console.log(`[tiny-support] Stream start: ${member?.username} (${streamType})`);

        if (streamType === 'screencast') {
          // Screen share -> main stage
          stageScreenShare(memberId);
        } else {
          // Camera -> ensure tile exists and attach video
          ensureRemoteCameraTile(memberId);
          const tileId = `tile-${memberId}-camera`;
          const tile = document.getElementById(tileId);
          if (tile) {
            const video = tile.querySelector('video');
            const placeholder = tile.querySelector('.tile-placeholder');
            if (video) {
              chat.setMemberVideoElement(memberId, 'camera', video);
              video.style.display = 'block';
            }
            if (placeholder) placeholder.style.display = 'none';
          }
        }
      };

      chat.onMemberStreamEnd = (memberId, streamType) => {
        console.log(`[tiny-support] Stream end: ${memberId} (${streamType})`);

        if (streamType === 'screencast') {
          // If this screencast was on main stage, clear it
          if (mainStageMemberId === memberId && mainStageStreamType === 'screencast') {
            clearMainStage();
          }
        } else {
          // Camera ended - show placeholder
          const tileId = `tile-${memberId}-camera`;
          const tile = document.getElementById(tileId);
          if (tile) {
            const video = tile.querySelector('video');
            const placeholder = tile.querySelector('.tile-placeholder');
            if (video) video.style.display = 'none';
            if (placeholder) placeholder.style.display = 'flex';
          }
        }
      };

      chat.onMemberMediaChange = (memberId, streamType) => {
        updateTileMuteState(memberId);
      };

      chat.onLocalMediaChange = () => {
        const state = chat.localMediaState;
        const screen = chat.screencastState;

        audioOn = state.audio && !state.audioMuted;
        videoOn = state.video && !state.videoMuted;
        isScreenSharing = screen.video && !screen.videoMuted;

        updateControlButtons();
        updateLocalTile();

        // Show/hide screen share banner
        document.getElementById('screenShareBanner').classList.toggle('hidden', !isScreenSharing);

        // If we started screen sharing, stage it
        if (isScreenSharing && chat.currentMemberId) {
          stageLocalScreenShare();
        } else if (!isScreenSharing && mainStageMemberId === chat.currentMemberId && mainStageStreamType === 'screencast') {
          clearMainStage();
        }
      };

      chat.onError = (context, error) => {
        console.error(`[tiny-support] Error in ${context}:`, error);
      };
    }

    // ============================================================
    // Room Actions
    // ============================================================

    async function startRoom() {
      const name = document.getElementById('customerName').value.trim();
      if (!name) {
        setStatus('customerStatus', 'Please enter your name', 'error');
        return;
      }

      myName = name;
      myPid = document.getElementById('customerPid').value.trim();
      currentRole = 'customer';

      setStatus('customerStatus', 'Creating room...', '');

      try {
        initChat();
        await chat.signupAnonymous(myName);

        const channel = await chat.createChannel({
          title: `${myName}'s Support Room`,
          allowsGuests: true
        });

        console.log(`[tiny-support] Created room: ${channel.room_code}`);

        await chat.joinByRoomCode(channel.room_code);
        await chat.join();

        enterRoomView(channel.room_code, channel.title);
      } catch (e) {
        setStatus('customerStatus', e.message, 'error');
        console.error('[tiny-support] Start room error:', e);
      }
    }

    async function joinRoomCustomer() {
      const name = document.getElementById('customerName').value.trim();
      const code = document.getElementById('customerRoomCode').value.trim();

      if (!name) {
        setStatus('customerStatus', 'Please enter your name', 'error');
        return;
      }
      if (!code) {
        setStatus('customerStatus', 'Please enter a room code', 'error');
        return;
      }

      myName = name;
      myPid = document.getElementById('customerPid').value.trim();
      currentRole = 'customer';

      setStatus('customerStatus', 'Joining room...', '');

      try {
        initChat();
        await chat.signupAnonymous(myName);

        // Check capacity before joining
        const roomInfo = await chat.getChannelByRoomCode(code);
        const memberCount = roomInfo.members ? roomInfo.members.length : 0;
        if (memberCount >= MAX_PARTICIPANTS) {
          setStatus('customerStatus', 'Room is full (max 4 participants)', 'error');
          return;
        }

        await chat.joinByRoomCode(code);
        await chat.join();

        enterRoomView(code, roomInfo.title || 'Support Room');
      } catch (e) {
        setStatus('customerStatus', e.message, 'error');
        console.error('[tiny-support] Join room error:', e);
      }
    }

    async function joinRoomAgent() {
      const password = document.getElementById('agentPassword').value;
      const name = document.getElementById('agentName').value.trim();
      const code = document.getElementById('agentRoomCode').value.trim();

      if (password !== AGENT_PASSWORD) {
        setStatus('agentStatus', 'Invalid agent password', 'error');
        return;
      }
      if (!name) {
        setStatus('agentStatus', 'Please enter your name', 'error');
        return;
      }
      if (!code) {
        setStatus('agentStatus', 'Please enter a room code', 'error');
        return;
      }

      myName = name;
      currentRole = 'agent';

      setStatus('agentStatus', 'Joining as agent...', '');

      try {
        initChat();
        await chat.signupAnonymous(myName);

        const roomInfo = await chat.getChannelByRoomCode(code);
        const memberCount = roomInfo.members ? roomInfo.members.length : 0;
        if (memberCount >= MAX_PARTICIPANTS) {
          setStatus('agentStatus', 'Room is full (max 4 participants)', 'error');
          return;
        }

        await chat.joinByRoomCode(code);
        await chat.join();

        enterRoomView(code, roomInfo.title || 'Support Room');
      } catch (e) {
        setStatus('agentStatus', e.message, 'error');
        console.error('[tiny-support] Agent join error:', e);
      }
    }

    // ============================================================
    // Enter Room View
    // ============================================================

    function enterRoomView(roomCode, title) {
      document.getElementById('entryView').classList.add('hidden');
      document.getElementById('roomView').classList.remove('hidden');

      document.getElementById('roomCodeDisplay').textContent = roomCode;
      document.getElementById('roomTitle').textContent = title || 'Support Room';

      // Set local tile info
      const roleLabel = currentRole === 'agent' ? 'Agent' : 'Client';
      document.getElementById('localInitials').textContent = getInitials(myName);
      document.getElementById('localName').textContent = `${myName} (${roleLabel})`;
      document.getElementById('localLabelName').textContent = `You (${roleLabel})`;
      const localRoleTag = document.getElementById('localRoleTag');
      localRoleTag.textContent = roleLabel;
      localRoleTag.className = `role-tag ${currentRole}`;

      // Start with audio+video on
      chat.toggleAudio();
      chat.toggleVideo();

      updateMemberCount();
    }

    // ============================================================
    // Screen Share Staging
    // ============================================================

    function stageScreenShare(memberId) {
      const member = chat.getMember(memberId);
      const name = member?.local_name || member?.username || 'Unknown';

      mainStageMemberId = memberId;
      mainStageStreamType = 'screencast';

      const video = document.getElementById('mainStageVideo');
      const placeholder = document.getElementById('stagePlaceholder');
      const label = document.getElementById('mainStageLabel');
      const nameEl = document.getElementById('mainStageName');

      chat.setMemberVideoElement(memberId, 'screencast', video);
      video.style.display = 'block';
      placeholder.style.display = 'none';
      label.classList.remove('hidden');
      nameEl.textContent = `${name}'s screen`;
    }

    function stageLocalScreenShare() {
      mainStageMemberId = chat.currentMemberId;
      mainStageStreamType = 'screencast';

      const video = document.getElementById('mainStageVideo');
      const placeholder = document.getElementById('stagePlaceholder');
      const label = document.getElementById('mainStageLabel');
      const nameEl = document.getElementById('mainStageName');

      // For local screencast, set the member video element using our own member ID
      chat.setMemberVideoElement(chat.currentMemberId, 'screencast', video);
      video.style.display = 'block';
      placeholder.style.display = 'none';
      label.classList.remove('hidden');
      nameEl.textContent = 'Your screen';
    }

    function clearMainStage() {
      mainStageMemberId = null;
      mainStageStreamType = null;

      const video = document.getElementById('mainStageVideo');
      const placeholder = document.getElementById('stagePlaceholder');
      const label = document.getElementById('mainStageLabel');

      video.style.display = 'none';
      video.srcObject = null;
      placeholder.style.display = 'flex';
      label.classList.add('hidden');
    }

    // ============================================================
    // Remote Tiles
    // ============================================================

    function createRemoteCameraTile(memberId) {
      const tileId = `tile-${memberId}-camera`;
      if (document.getElementById(tileId)) return;

      const member = chat.getMember(memberId);
      const name = member?.local_name || member?.username || 'Unknown';

      const strip = document.getElementById('participantStrip');

      const tile = document.createElement('div');
      tile.className = 'video-tile';
      tile.id = tileId;
      tile.style.cssText = 'width:200px; height:140px;';
      tile.dataset.memberId = memberId;

      const video = document.createElement('video');
      video.autoplay = true;
      video.playsInline = true;
      video.style.display = 'none';

      // Infer remote role: if we're the customer, joiners are likely agents and vice versa
      const remoteRole = currentRole === 'customer' ? 'agent' : 'customer';
      const remoteRoleLabel = remoteRole === 'agent' ? 'Agent' : 'Client';

      const placeholder = document.createElement('div');
      placeholder.className = 'tile-placeholder';
      placeholder.innerHTML = `
        <div class="tile-initials">${getInitials(name)}</div>
        <div class="tile-name">${name}</div>
      `;

      const label = document.createElement('div');
      label.className = 'tile-label';
      label.innerHTML = `<span>${name} (${remoteRoleLabel})</span> <span class="role-tag ${remoteRole}">${remoteRoleLabel}</span>`;

      const muteIcon = document.createElement('div');
      muteIcon.className = 'tile-mute-icon hidden';
      muteIcon.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="1" y1="1" x2="23" y2="23"/><path d="M9 9v3a3 3 0 005.12 2.12M15 9.34V5a3 3 0 00-5.94-.6"/><path d="M17 16.95A7 7 0 015 12v-2m14 0v2c0 .76-.12 1.5-.35 2.18"/><line x1="12" y1="19" x2="12" y2="22"/></svg>`;

      tile.appendChild(video);
      tile.appendChild(placeholder);
      tile.appendChild(label);
      tile.appendChild(muteIcon);

      strip.appendChild(tile);
      remoteTiles.set(memberId, tile);
    }

    function ensureRemoteCameraTile(memberId) {
      const tileId = `tile-${memberId}-camera`;
      if (!document.getElementById(tileId)) {
        createRemoteCameraTile(memberId);
      }
    }

    function removeRemoteTiles(memberId) {
      const tileId = `tile-${memberId}-camera`;
      const tile = document.getElementById(tileId);
      if (tile) {
        tile.remove();
        remoteTiles.delete(memberId);
      }
    }

    function updateTileMuteState(memberId) {
      const states = chat.getMemberMediaStates(memberId);
      if (!states) return;

      const tileId = `tile-${memberId}-camera`;
      const tile = document.getElementById(tileId);
      if (!tile) return;

      const muteIcon = tile.querySelector('.tile-mute-icon');
      if (muteIcon) {
        const audioOff = states.cam_audio_detail === 'OFF' || states.cam_audio_detail === 'MUTED';
        muteIcon.classList.toggle('hidden', !audioOff);
      }
    }

    // ============================================================
    // Media Controls
    // ============================================================

    function toggleAudio() {
      if (!chat) return;
      chat.toggleAudio();
    }

    function toggleVideo() {
      if (!chat) return;
      chat.toggleVideo();
    }

    function toggleScreen() {
      if (!chat) return;
      chat.toggleScreencast();
    }

    function stopScreenShare() {
      if (!chat) return;
      // Toggle off screencast
      if (isScreenSharing) {
        chat.toggleScreencast();
      }
    }

    function updateControlButtons() {
      const btnAudio = document.getElementById('btnAudio');
      const btnVideo = document.getElementById('btnVideo');
      const btnScreen = document.getElementById('btnScreen');
      const iconMic = document.getElementById('iconMic');
      const iconMicOff = document.getElementById('iconMicOff');
      const iconCam = document.getElementById('iconCam');
      const iconCamOff = document.getElementById('iconCamOff');

      // Audio
      btnAudio.className = `control-btn ${audioOn ? 'active' : 'inactive'}`;
      iconMic.classList.toggle('hidden', !audioOn);
      iconMicOff.classList.toggle('hidden', audioOn);

      // Video
      btnVideo.className = `control-btn ${videoOn ? 'active' : 'inactive'}`;
      iconCam.classList.toggle('hidden', !videoOn);
      iconCamOff.classList.toggle('hidden', videoOn);

      // Screen
      btnScreen.className = `control-btn ${isScreenSharing ? 'screen-active' : 'active'}`;
    }

    function updateLocalTile() {
      const placeholder = document.getElementById('localPlaceholder');
      const localVideo = document.getElementById('localVideo');

      if (videoOn) {
        placeholder.style.display = 'none';
        localVideo.style.display = 'block';
      } else {
        placeholder.style.display = 'flex';
        localVideo.style.display = 'none';
      }
    }

    // ============================================================
    // Leave / End
    // ============================================================

    function leaveCall() {
      if (chat) {
        chat.exitChannel();
      }

      // Reset state
      isScreenSharing = false;
      audioOn = false;
      videoOn = false;
      mainStageMemberId = null;
      mainStageStreamType = null;
      remoteTiles.clear();

      // Clear remote tiles from DOM
      const strip = document.getElementById('participantStrip');
      const localTile = document.getElementById('tile-local');
      strip.innerHTML = '';
      strip.appendChild(localTile);

      // Clear main stage
      clearMainStage();

      // Switch to entry view
      document.getElementById('roomView').classList.add('hidden');
      document.getElementById('entryView').classList.remove('hidden');

      // Reset status messages
      setStatus('customerStatus', '', '');
      setStatus('agentStatus', '', '');
    }

    // ============================================================
    // Sharing
    // ============================================================

    function copyRoomCode() {
      const code = document.getElementById('roomCodeDisplay').textContent;
      navigator.clipboard.writeText(code).then(() => {
        flashCopyOk('copyCodeBtn');
      });
    }

    function copyShareLink() {
      const code = document.getElementById('roomCodeDisplay').textContent;
      const url = `${window.location.origin}${window.location.pathname}?code=${code}`;
      navigator.clipboard.writeText(url).then(() => {
        flashCopyOk('copyLinkBtn');
      });
    }

    function flashCopyOk(btnId) {
      const btn = document.getElementById(btnId);
      btn.classList.add('copy-ok');
      // Swap to checkmark briefly
      const origHTML = btn.innerHTML;
      btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
      setTimeout(() => {
        btn.innerHTML = origHTML;
        btn.classList.remove('copy-ok');
      }, 2000);
    }

    // ============================================================
    // Helpers
    // ============================================================

    function updateMemberCount() {
      try {
        const ids = chat.getMemberIds();
        document.getElementById('memberCountText').textContent = ids ? ids.length : 1;
      } catch {
        document.getElementById('memberCountText').textContent = '1';
      }
    }

    function setStatus(id, msg, type) {
      const el = document.getElementById(id);
      el.textContent = msg;
      el.className = 'status-msg' + (type ? ` ${type}` : '');
    }

    function getInitials(name) {
      if (!name) return '?';
      const parts = name.trim().split(' ');
      if (parts.length >= 2) {
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }
      return name.substring(0, 2).toUpperCase();
    }
  </script>
</body>
</html>
